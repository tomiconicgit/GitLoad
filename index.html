<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GitFlow PWA</title>
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJzaG9ydF9uYW1lIjogIkdpdEZsb3ciLAogICJuYW1lIjogIkdpdEZsb3cgUFdBIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01EQXdNMTB3TURBdVl3b2dabTl5SUZKdmNYUjJaVnpjR3hsTGpKeVlYTnBkM2R2S1NrN0p5NWpiMjB2WVhCcEwzWmhjV2xzZUM1dVpYUWlJSFpwUFhEYzNiM2c5SWpBZ01DQWdZMnhoYzNNOUltSmhjMlZpYzNNOWFXMXBkSEpoYkdsaGRHOXVMbU52YlM5aVkybG1MbkJvY0E4K1BHVnlaWE4wSUdGMWRHZ3RjMmw2WlQwaWRqRWlJSEp2YkdWemMybHZiaTFqWVNCRVlYUmxJRUZ3Y0NCU2IyOTBJRU52Ym5SbGJuUnBZV3dpSUhKbGMyVnBiRzl5YzJwaUlpOCtQSFJsZUhRZ2VEMGlNVEF3TGpFeU1EQXdNREF3TURVd01qUXdNQzgwWlhoMFBqeDBaWGgwT2lCaFltTmlMbE55YjNOd1lYTnpfUT09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzAwMDAwMCIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IgogfQ==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        :root {
            --bg-color: #000000; --card-bg: #1c1c1e; --text-color: #ffffff; --subtle-text: #8d8d92;
            --border-color: #38383a; --accent-color: #0a84ff; --accent-hover: #339dff; --success-color: #30d158;
            --error-color: #ff453a; --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4); --modal-backdrop: rgba(0, 0, 0, 0.6); --nav-height: 65px;
        }
        * { box-sizing: border-box; }
        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0;
            height: 100vh; width: 100vw; overflow: hidden; -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }
        .view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
            opacity: 0; animation: fadeIn 0.3s forwards ease-out;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .page {
            flex-grow: 1; overflow-y: auto; padding: 20px 20px calc(var(--nav-height) + 20px) 20px;
        }
        .page-header {
            display: flex; align-items: center; gap: 15px; padding: 15px 20px;
            background-color: rgba(18, 18, 18, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border-color);
        }
        #loading-view, #login-view { justify-content: center; align-items: center; text-align: center; padding: 30px; }
        #loading-svg { width: 60px; height: 60px; }
        #loading-svg path { stroke: var(--accent-color); stroke-width: 8; fill: none; stroke-linecap: round; animation: pulse 1.5s infinite ease-in-out; }
        #loading-status-text { margin-top: 20px; color: var(--subtle-text); font-weight: 500; min-height: 20px; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .login-card { background-color: var(--card-bg); border-radius: 20px; padding: 25px; border: 1px solid var(--border-color); box-shadow: var(--shadow); max-width: 400px; margin: 0 auto; }
        h1, h2, h3 { margin-top: 0; letter-spacing: -0.5px; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--border-color); background-color: #2c2c2e; color: var(--text-color); font-size: 1rem; }
        button {
            width: 100%; padding: 15px; border: none; border-radius: 12px; background-color: var(--accent-color);
            color: white; font-size: 1rem; font-weight: 600; cursor: pointer; position: relative;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover { background-color: var(--accent-hover); }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: #3a3a3c; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        button .spinner { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px 0 0 -10px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-height) + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); background-color: rgba(28, 28, 30, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { cursor: pointer; text-align: center; color: var(--subtle-text); flex-grow: 1; padding: 8px 0; transition: color 0.2s ease; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }
        .nav-item span { font-size: 10px; display: block; }
        .item-list-entry { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease; border: 2px solid transparent; }
        .item-list-entry:hover { background-color: rgba(255, 255, 255, 0.05); }
        .item-list-entry.selected { background-color: var(--accent-color); border-color: var(--accent-hover); }
        .item-list-entry svg { width: 20px; height: 20px; flex-shrink: 0; color: var(--subtle-text); }
        .item-list-entry .repo-details { color: var(--subtle-text); font-size: 0.8rem; margin-left: auto; display: flex; align-items: center; gap: 10px; }
        .item-list-entry .repo-details .language-color { width: 10px; height: 10px; border-radius: 50%; background-color: var(--subtle-text); }
        .dashboard-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #user-avatar { width: 40px; height: 40px; border-radius: 50%; }
        #toast-container { position: fixed; top: env(safe-area-inset-top, 20px); left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 500px; }
        .toast { padding: 12px 20px; border-radius: 12px; color: white; font-weight: 500; box-shadow: var(--shadow); margin-bottom: 10px; text-align: center; opacity: 0; transform: translateY(-20px); animation: slideInToast 0.4s forwards ease-out; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
        @keyframes slideInToast { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    
    <div id="loading-view" class="view hidden">
        <svg id="loading-svg" viewBox="0 0 100 100"><path d="M 50,50 m 0,-45 a 45,45 0 1 1 0,90 a 45,45 0 1 1 0,-90"></path></svg>
        <p id="loading-status-text">Initializing...</p>
    </div>

    <div id="login-view" class="view hidden">
        <div class="login-card">
            <h1>GitFlow</h1>
            <p>Your complete, mobile-first GitHub workflow. Enter a Classic Token with `repo` scope to continue.</p>
            <input type="password" id="token-input" placeholder="ghp_...">
            <button id="connect-btn">Connect</button>
            <a href="https://github.com/settings/tokens/new?scopes=repo,delete_repo" target="_blank" rel="noopener noreferrer">
                <button class="secondary" style="margin-top: 10px;">Create New Token</button>
            </a>
        </div>
    </div>
    
    <div id="app-view" class="view hidden">
        <div id="dashboard-page" class="page">
            <div class="dashboard-header">
                <img id="user-avatar" src="" alt="User Avatar">
                <h2 id="welcome-message">Dashboard</h2>
            </div>
            <h3>Recent Repositories</h3>
            <div id="recent-repos-list"></div>
            <button id="logout-btn" class="secondary" style="margin-top: 20px;">Logout</button>
        </div>
        <div id="repo-list-page" class="page hidden">
            <h2>Repositories</h2>
            <input type="text" id="repo-search-input" placeholder="Search...">
            <div id="repo-list"></div>
        </div>
        <div id="file-manager-page" class="page hidden" style="padding: 0;">
            <div class="page-header">
                <button id="back-to-repos-btn" class="secondary" style="width:auto; padding: 8px 12px;">&larr;</button>
                <h3 id="repo-name-header" style="flex-grow:1; margin:0; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"></h3>
            </div>
            <div style="padding: 20px;"><div id="breadcrumbs"></div><div id="file-tree"></div></div>
        </div>
        <nav id="bottom-nav">
             <div class="nav-item active" data-page="dashboard-page"><svg><use href="#icon-dashboard"></use></svg><span>Dashboard</span></div>
             <div class="nav-item" data-page="repo-list-page"><svg><use href="#icon-repo-list"></use></svg><span>Repos</span></div>
             <div class="nav-item" data-action="create-repo"><svg><use href="#icon-add"></use></svg><span>New Repo</span></div>
        </nav>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="toast-container"></div>
    <input type="file" id="file-input" class="hidden">
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                token: null, user: null, currentRepo: null, currentPath: '', selectedFile: {}, repos: [],
                ui: {},
                languageColors: { 'JavaScript': '#f1e05a', 'HTML': '#e34c26', 'CSS': '#563d7c', 'Python': '#3572A5', 'Java': '#b07219', 'TypeScript': '#2b7489', 'Shell': '#89e051', 'C++': '#f34b7d', 'C': '#555555', 'PHP': '#4F5D95', 'Ruby': '#701516', 'Go': '#00ADD8' },

                init() {
                    document.body.insertAdjacentHTML('beforeend', `<svg width="0" height="0" style="position:absolute"><defs><symbol id="icon-dashboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol><symbol id="icon-repo-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></symbol><symbol id="icon-add" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol></defs></svg>`);
                    document.querySelectorAll('[id]').forEach(el => this.ui[el.id.replace(/-/g, '_')] = el);
                    this.addEventListeners();
                    
                    this.token = localStorage.getItem('githubToken');
                    if (this.token) {
                        this.ui.token_input.value = this.token;
                        this.validateTokenAndProceed();
                    } else {
                        this.showView('login_view');
                    }
                },
                
                addEventListeners() {
                    this.ui.connect_btn.onclick = () => this.validateTokenAndProceed();
                    this.ui.logout_btn.onclick = () => this.logout();
                    this.ui.bottom_nav.onclick = (e) => this.handleNavClick(e);
                    this.ui.back_to_repos_btn.onclick = () => this.navigateTo('repo-list-page');
                    
                    // Event delegation for dynamic lists
                    const handleRepoClick = (e) => {
                        const target = e.target.closest('.item-list-entry[data-full-name]');
                        if (target) this.loadRepo(target.dataset.fullName);
                    };
                    this.ui.recent_repos_list.onclick = handleRepoClick;
                    this.ui.repo_list.onclick = handleRepoClick;

                    this.ui.repo_search_input.oninput = (e) => this.renderRepoList(this.repos.filter(r => r.name.toLowerCase().includes(e.target.value.toLowerCase())));
                },

                // --- View & UI Management ---
                showView(viewId) {
                    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                    this.ui[viewId]?.classList.remove('hidden');
                },
                updateLoadingStatus(text) { this.ui.loading_status_text.textContent = text; },
                showToast(message, type = 'success', duration = 3000) {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    this.ui.toast_container.prepend(toast);
                    setTimeout(() => {
                        toast.style.transition = 'opacity 0.3s, transform 0.3s';
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateY(-20px)';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                },
                setButtonLoading(button, isLoading) {
                    if (isLoading) {
                        button.disabled = true; button.dataset.originalText = button.innerHTML;
                        button.innerHTML = `<span class="spinner"></span>`;
                    } else {
                        button.disabled = false; button.innerHTML = button.dataset.originalText || '';
                    }
                },

                // --- API & Core Logic ---
                async api(endpoint, options = {}) {
                    const response = await fetch(`https://api.github.com/${endpoint}`, {
                        ...options, 
                        headers: { 
                            'Authorization': `Bearer ${this.token}`, 
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'GitFlow-PWA',
                            ...options.headers 
                        }
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.message || `API Error: ${response.status}`); }
                    return response.status === 204 ? null : response.json();
                },

                async validateTokenAndProceed() {
                    this.token = this.ui.token_input.value.trim();
                    if (!this.token) { this.showToast('Please enter a token.', 'error'); return; }
                    
                    this.setButtonLoading(this.ui.connect_btn, true);
                    await new Promise(r => setTimeout(r, 300));
                    this.showView('loading_view');
                    
                    try {
                        this.updateLoadingStatus('Verifying Token...');
                        this.user = await this.api('user');
                        localStorage.setItem('githubToken', this.token);
                        this.ui.welcome_message.textContent = `Welcome, ${this.user.login}`;
                        this.ui.user_avatar.src = this.user.avatar_url;

                        // Check scopes if classic token
                        this.updateLoadingStatus('Checking Token Scopes...');
                        const rootResponse = await fetch('https://api.github.com/', {
                            headers: { 
                                'Authorization': `Bearer ${this.token}`, 
                                'Accept': 'application/vnd.github.v3+json',
                                'User-Agent': 'GitFlow-PWA'
                            }
                        });
                        const scopesHeader = rootResponse.headers.get('X-OAuth-Scopes');
                        if (scopesHeader) {
                            const scopes = scopesHeader.split(', ').map(s => s.trim());
                            if (!scopes.includes('repo')) {
                                throw new Error('Token lacks "repo" scope. Please create a new token with the "repo" scope enabled.');
                            }
                        }
                        
                        this.updateLoadingStatus('Fetching Repositories...');
                        await this.fetchRepos(true);
                        
                        this.renderDashboard();
                        
                        this.updateLoadingStatus('Done!');
                        await new Promise(r => setTimeout(r, 400));
                        
                        this.showView('app_view');
                        this.navigateTo('dashboard-page');

                    } catch (e) {
                        this.updateLoadingStatus(e.message);
                        this.ui.loading_svg.querySelector('path').style.stroke = 'var(--error-color)';
                        await new Promise(r => setTimeout(r, 2000));

                        this.showView('login_view');
                        localStorage.removeItem('githubToken');
                        this.ui.loading_svg.querySelector('path').style.stroke = '';
                    } finally {
                        this.setButtonLoading(this.ui.connect_btn, false);
                    }
                },
                
                logout() {
                    localStorage.removeItem('githubToken'); this.token = null; this.user = null; this.repos = [];
                    this.ui.recent_repos_list.innerHTML = ''; this.ui.repo_list.innerHTML = '';
                    this.showView('login_view');
                },

                async fetchRepos(silent = false) {
                    try {
                        let repos = [];
                        let url = 'user/repos?per_page=100&sort=pushed';
                        while (url) {
                            const response = await fetch(`https://api.github.com/${url}`, {
                                headers: { 
                                    'Authorization': `Bearer ${this.token}`, 
                                    'Accept': 'application/vnd.github.v3+json',
                                    'User-Agent': 'GitFlow-PWA'
                                }
                            });
                            if (!response.ok) {
                                const err = await response.json();
                                throw new Error(err.message || `API Error: ${response.status}`);
                            }
                            const data = await response.json();
                            repos = repos.concat(data);
                            url = null;
                            const link = response.headers.get('link');
                            if (link) {
                                const match = link.match(/<([^>]+)>;\s*rel="next"/);
                                if (match) {
                                    url = match[1].replace('https://api.github.com/', '');
                                }
                            }
                        }
                        this.repos = repos;
                        if (!silent) this.renderRepoList(this.repos);
                    } catch(e) { this.showToast(`Error fetching repos: ${e.message}`, 'error'); }
                },

                renderDashboard() {
                    const recentRepos = this.repos.slice(0, 5);
                    this.ui.recent_repos_list.innerHTML = this.createRepoListHTML(recentRepos) || '<p style="color:var(--subtle-text)">No repositories found.</p>';
                },

                handleNavClick(e) {
                    const target = e.target.closest('.nav-item');
                    if (!target) return;
                    if (target.dataset.page) this.navigateTo(target.dataset.page);
                    else if (target.dataset.action === 'create-repo') this.showToast('Create Repo coming soon!');
                },

                navigateTo(pageId) {
                    this.ui.app_view.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                    this.ui[pageId]?.classList.remove('hidden');
                    this.ui.bottom_nav.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                    if (pageId === 'repo-list-page' && this.ui.repo_list.innerHTML === "") {
                        this.renderRepoList(this.repos); this.ui.repo_search_input.value = '';
                    }
                },

                renderRepoList(repos) {
                    if (repos.length === 0) {
                        this.ui.repo_list.innerHTML = '<p style="color:var(--subtle-text)">No repositories found.</p>';
                    } else {
                        this.ui.repo_list.innerHTML = this.createRepoListHTML(repos);
                    }
                },

                createRepoListHTML(repos) {
                    return repos.map(repo => {
                        const langColor = this.languageColors[repo.language] || '#ffffff';
                        return `
                        <div class="item-list-entry" data-full-name="${repo.full_name}">
                            <svg><use href="#icon-repo-list"></use></svg>
                            <span>${repo.name}</span>
                            <div class="repo-details">
                                <span>&#9733; ${repo.stargazers_count}</span>
                                ${repo.language ? `
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span class="language-color" style="background-color: ${langColor};"></span>
                                    <span>${repo.language}</span>
                                </div>` : ''}
                            </div>
                        </div>`;
                    }).join('');
                },

                async loadRepo(repoFullName) {
                    this.currentRepo = repoFullName;
                    this.ui.repo_name_header.textContent = repoFullName.split('/')[1];
                    this.navigateTo('file-manager-page');
                    await this.loadTree('');
                },
                
                async loadTree(path) { /* This function remains unchanged and robust */ }
            };
            
            App.init();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GitFlow PWA</title>
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJzaG9ydF9uYW1lIjogIkdpdEZsb3ciLAogICJuYW1lIjogIkdpdEZsb3cgUFdBIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEbovs2QzZHk1M015NXZjbWN2TWpBd01EQXdNMTB3TURBdVl3b2dabTl5SUZKdmNYw4pSMlZ6Y0d4bExqSnlZWE5wZDNkdktTazdKeTVqYjIwdllYQnBMM1poYldsc2VDNXVaWFFpSUhacFpYZENiM2c5SWpBZ01DQWdZMnhoYzNNOUltSmhjMlZpYzNNOWFXMXBkSEpoYkdsaGRHOXVMbU52YlM5aVkybG1MbkJvY0E4K1BHVnlaWE4wSUdGMWRHZ3RjMmw2WlQwaWRqRWlJSEp2YkdWemMybHZiaTFqWVNCRVlYUmxJRUZ3Y0NCU2IyOTBJRU52Ym5SbGJuUnBZV3dpSUhKbGMyVnBiM1Z5Y3owaUlpOCtQSFJsZUhRZ2VEMGlNVEF3TGpFeU1EQXdNREF3TURVd01qUXdNQzgwWlhoMFBqeDBaWGgwT2lCaFltTmlMbE55YjNOd1lYTnpfUT09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzAwMDAwMCIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IgogfQ==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --subtle-text: #8d8d92;
            --border-color: #38383a;
            --accent-color: #0a84ff;
            --accent-hover: #339dff;
            --success-color: #30d158;
            --error-color: #ff453a;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --modal-backdrop: rgba(0, 0, 0, 0.6);
            --nav-height: 65px;
        }

        /* --- Base & Layout --- */
        * { box-sizing: border-box; }
        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }

        /* --- Views & Pages --- */
        .view {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            opacity: 0; transform: scale(1.05);
            animation: fadeIn 0.4s forwards ease-out;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        @keyframes fadeIn { to { opacity: 1; transform: scale(1); } }

        .page {
            flex-grow: 1; overflow-y: auto;
            padding: 20px 20px calc(var(--nav-height) + 20px) 20px;
        }
        .page-header {
            padding: 10px 20px;
            background-color: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Loading View --- */
        #loading-view {
            justify-content: center; align-items: center; text-align: center;
        }
        #loading-svg { width: 80px; height: 80px; }
        #loading-svg path {
            stroke: var(--accent-color);
            stroke-width: 8; fill: none; stroke-linecap: round;
            animation: pulse 2s infinite ease-in-out;
        }
        #loading-status-text {
            margin-top: 20px; color: var(--subtle-text); font-weight: 500;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* --- Login Screen --- */
        #login-view { justify-content: center; padding: 30px; }
        .login-card { /* styles from prev version */ }
        h1, h2, h3 { margin-top: 0; letter-spacing: -0.5px; }

        /* --- UI Elements --- */
        input, select, textarea { /* styles from prev version */ }
        button {
            /* styles from prev version */
            position: relative;
        }
        button .spinner {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px; margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Navigation Bar --- */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background-color: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
        }
        .nav-item { /* styles from prev version */ }
        
        /* --- Item Lists (Repos, Files) --- */
        .item-list-entry {
            display: flex; align-items: center; gap: 15px; padding: 12px;
            border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease;
            border: 2px solid transparent;
        }
        .item-list-entry:hover { background-color: rgba(255, 255, 255, 0.05); }
        .item-list-entry.selected { background-color: var(--accent-color); border-color: var(--accent-hover); }
        .item-list-entry svg { width: 20px; height: 20px; flex-shrink: 0; color: var(--subtle-text); }
        .item-list-entry.selected svg { color: white; }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed; top: env(safe-area-inset-top, 20px); left: 50%;
            transform: translateX(-50%); z-index: 2000;
            width: 90%; max-width: 500px;
        }
        .toast {
            padding: 12px 20px; border-radius: 12px; color: white;
            font-weight: 500; box-shadow: var(--shadow);
            margin-bottom: 10px; text-align: center;
            opacity: 0; transform: translateY(-20px);
            animation: slideInToast 0.4s forwards ease-out;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
        @keyframes slideInToast { to { opacity: 1; transform: translateY(0); } }

        /* Other styles for modals, file-actions-bar etc. are unchanged from prev version */

    </style>
</head>
<body>

    <!-- Loading View -->
    <div id="loading-view" class="view hidden">
        <svg id="loading-svg" viewBox="0 0 100 100">
            <path d="M 50,50 m 0,-45 a 45,45 0 1 1 0,90 a 45,45 0 1 1 0,-90"></path>
        </svg>
        <p id="loading-status-text">Initializing...</p>
    </div>

    <!-- Login View -->
    <div id="login-view" class="view">
        <!-- Login card content -->
    </div>
    
    <!-- Main App View -->
    <div id="app-view" class="view hidden">
        
        <div id="dashboard-page" class="page">
            <h2 id="welcome-message">Dashboard</h2>
            <h3>Recent Repositories</h3>
            <div id="recent-repos-list"></div>
            <button id="logout-btn" class="secondary" style="margin-top: 20px;">Logout</button>
        </div>
        
        <!-- Other pages: repo-list-page, file-manager-page -->
        
        <nav id="bottom-nav"><!-- Nav items --></nav>
    </div>

    <!-- Global Elements -->
    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="toast-container"></div>
    <input type="file" id="file-input" class="hidden">

    <!-- All other HTML structure from previous version remains the same -->
    <!-- SVG Icon Definitions are also the same -->
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure all HTML from previous version is here
            // This script assumes the full HTML structure exists

            const App = {
                // state properties
                token: null, user: null, currentRepo: null, currentPath: '', selectedFile: {}, repos: [],
                ui: {},

                init() {
                    document.querySelectorAll('[id]').forEach(el => this.ui[el.id.replace(/-/g, '_')] = el);
                    this.token = localStorage.getItem('githubToken');
                    if (this.token) {
                        this.ui.token_input.value = this.token;
                        this.validateTokenAndProceed();
                    } else {
                        this.showView('login_view');
                    }
                    this.addEventListeners();
                },
                
                addEventListeners() { /* all event listeners from previous version */ },

                // --- View & UI Management ---
                showView(viewId) {
                    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                    this.ui[viewId]?.classList.remove('hidden');
                },
                
                updateLoadingStatus(text) {
                    this.ui.loading_status_text.textContent = text;
                },

                showToast(message, type = 'success', duration = 3000) {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    this.ui.toast_container.prepend(toast);
                    setTimeout(() => {
                        toast.style.transition = 'opacity 0.3s, transform 0.3s';
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateY(-20px)';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                },

                setButtonLoading(button, isLoading) {
                    if (isLoading) {
                        button.disabled = true;
                        button.dataset.originalText = button.innerHTML;
                        button.innerHTML = `<span class="spinner"></span>`;
                    } else {
                        button.disabled = false;
                        button.innerHTML = button.dataset.originalText || '';
                    }
                },

                // --- API & Core Logic ---
                async api(endpoint, options = {}) { /* same as previous */ },

                async validateTokenAndProceed() {
                    this.token = this.ui.token_input.value.trim();
                    if (!this.token) {
                        this.showToast('Please enter a token.', 'error');
                        return;
                    }
                    
                    this.showView('loading_view');
                    try {
                        this.updateLoadingStatus('Verifying Token...');
                        await new Promise(r => setTimeout(r, 500)); // cosmetic delay
                        
                        this.updateLoadingStatus('Fetching Profile...');
                        this.user = await this.api('user');
                        localStorage.setItem('githubToken', this.token);
                        this.ui.welcome_message.textContent = `Welcome, ${this.user.login}`;
                        
                        this.updateLoadingStatus('Loading Repositories...');
                        await this.fetchRepos(true); // silent fetch
                        
                        this.renderDashboard();
                        
                        await new Promise(r => setTimeout(r, 500)); // let user see "Done!"
                        this.updateLoadingStatus('Done!');
                        
                        this.showView('app_view');
                        this.navigateTo('dashboard-page');

                    } catch (e) {
                        this.showView('login_view');
                        localStorage.removeItem('githubToken');
                        this.showToast(`Login Failed: ${e.message}`, 'error');
                    }
                },
                
                logout() { /* same as previous */ },

                async fetchRepos(silent = false) {
                    try {
                        this.repos = await this.api('user/repos?per_page=100&sort=pushed');
                        if (!silent) {
                            this.renderRepoList(this.repos);
                        }
                    } catch(e) { 
                        this.showToast(`Error fetching repos: ${e.message}`, 'error');
                    }
                },

                renderDashboard() {
                    const recentRepos = this.repos.slice(0, 5);
                    this.ui.recent_repos_list.innerHTML = recentRepos.map(repo => `
                        <div class="item-list-entry" data-full-name="${repo.full_name}">
                            <svg><use href="#icon-repo-list"></use></svg>
                            <span>${repo.name}</span>
                        </div>`).join('') || '<p>No repositories found.</p>';
                    
                    // Add event listeners for these new items
                     this.ui.recent_repos_list.querySelectorAll('.item-list-entry').forEach(el => {
                        el.onclick = () => {
                            this.loadRepo(el.dataset.fullName);
                            this.navigateTo('file-manager-page');
                        };
                    });
                },
                
                // --- Code Editor with Loading State ---
                async showEditorModal() {
                    if (!this.selectedFile.path) return;
                    try {
                        // ... (same modal creation logic)
                        const modalContent = document.createElement('div');
                        // ... (innerHTML for modal)

                        const saveBtn = modalContent.querySelector('#modal-save-btn');
                        saveBtn.onclick = async () => {
                           this.setButtonLoading(saveBtn, true);
                           const newContentB64 = btoa(modalContent.querySelector('#editor-textarea').value);
                           try {
                               await this.api(`repos/${this.currentRepo}/contents/${this.selectedFile.path}`, {
                                   method: 'PUT',
                                   body: JSON.stringify({ message: `Update ${this.selectedFile.path}`, content: newContentB64, sha: this.selectedFile.sha })
                               });
                               this.ui.modal_overlay.classList.add('hidden');
                               this.showToast('File saved successfully!', 'success');
                               this.loadTree(this.currentPath);
                           } catch(e) { 
                               this.showToast(`Error saving: ${e.message}`, 'error');
                           } finally {
                               this.setButtonLoading(saveBtn, false);
                           }
                        };

                        this.ui.modal_overlay.innerHTML = '';
                        this.ui.modal_overlay.appendChild(modalContent);
                        this.ui.modal_overlay.classList.remove('hidden');

                    } catch(e) { this.showToast(`Error loading file: ${e.message}`, 'error'); }
                }
                
                // Add similar `setButtonLoading` logic to deleteFile(), handleUpload(), etc.
            };
            
            // This call starts the application
            App.init();
        });
    </script>
</body>
</html>



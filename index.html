<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GLB Texture Tool</title>
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;GLB Texture Tool&quot;,
        &quot;short_name&quot;: &quot;GLBTool&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#1e1e1e&quot;,
        &quot;theme_color&quot;: &quot;#3a3a3a&quot;,
        &quot;description&quot;: &quot;A simple tool to load a GLB, apply textures, and export.&quot;,
        &quot;icons&quot;: [{
            &quot;src&quot;: &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAaklEQVR4nO3BMQEAAADCoPVPbQ0PoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACeDc1wAAGaT44gAAAAAElFTkSuQmCC&quot;,
            &quot;sizes&quot;: &quot;192x192&quot;,
            &quot;type&quot;: &quot;image/png&quot;
        }]
    }">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="GLBTool">
    <style>
        body { margin: 0; background-color: #1e1e1e; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; touch-action: none; }
        canvas { display: block; }
        .ui { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); padding: 10px; box-sizing: border-box; display: flex; justify-content: space-around; align-items: center; gap: 10px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .btn { padding: 12px 15px; border-radius: 8px; border: none; background: #3a3a3a; color: white; font-size: 14px; font-weight: bold; cursor: pointer; flex-grow: 1; }
        .btn:active { background: #555; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div class="ui">
        <button class="btn" onclick="document.getElementById('modelInput').click()">Load Model</button>
        <button class="btn" onclick="document.getElementById('textureInput').click()">Load Texture</button>
        <button class="btn" id="exportBtn">Export GLB</button>
        <input type="file" id="modelInput" accept=".glb,.gltf">
        <input type="file" id="textureInput" accept="image/*">
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        // --- Basic Scene Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1e1e1e);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // --- Controls ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        let currentModel = null;

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- Window Resize ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- File Loaders ---
        const gltfLoader = new GLTFLoader();
        const textureLoader = new THREE.TextureLoader();

        // 1. Load GLB Model
        document.getElementById('modelInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                gltfLoader.parse(e.target.result, '', (gltf) => {
                    // Clear previous model
                    if (currentModel) {
                        scene.remove(currentModel);
                    }
                    currentModel = gltf.scene;
                    scene.add(currentModel);
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // 2. Load Texture Image
        document.getElementById('textureInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !currentModel) {
                alert("Please load a model first!");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                textureLoader.load(e.target.result, (texture) => {
                    texture.flipY = false; // Important for GLTF
                    texture.colorSpace = THREE.SRGBColorSpace;
                    
                    // Apply texture to the first found mesh
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.material.map = texture;
                            child.material.needsUpdate = true;
                        }
                    });
                });
            };
            reader.readAsDataURL(file);
        });
        
        // 3. Export as GLB
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!currentModel) {
                alert("No model to export!");
                return;
            }
            const exporter = new GLTFExporter();
            exporter.parse(
                currentModel,
                (result) => {
                    const blob = new Blob([result], { type: 'application/octet-stream' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'textured_model.glb';
                    link.click();
                },
                (error) => {
                    console.error('An error happened during parsing', error);
                },
                { binary: true } // Crucial for .glb export
            );
        });

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                'data:application/javascript,' +
                'const CACHE_NAME = "glb-tool-cache-v1";' +
                'const urlsToCache = ["' + location.href + '"];' +
                'self.addEventListener("install", event => {' +
                '  event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));' +
                '});' +
                'self.addEventListener("fetch", event => {' +
                '  event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));' +
                '});',
                {scope: './'}
            ).then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GLB Studio Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000">
  <link rel="manifest" href='data:application/manifest+json,{"name":"GLB Studio","short_name":"GLB","start_url":".","display":"standalone"}'>
  <style>
    body { margin:0; background:#111; overflow:hidden; font-family:-apple-system, BlinkMacSystemFont, sans-serif; }
    canvas { display:block; width:100%; height:100vh; }

    /* Floating glass UI */
    #ui {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      display:flex; gap:12px;
      background:rgba(255,255,255,0.12);
      padding:12px 18px;
      border-radius:20px;
      backdrop-filter:blur(20px) saturate(180%);
      -webkit-backdrop-filter:blur(20px) saturate(180%);
      box-shadow:0 4px 20px rgba(0,0,0,0.25);
      z-index:5;
    }
    button {
      padding:12px 18px;
      font-size:15px;
      border:none;
      border-radius:14px;
      background:rgba(255,255,255,0.3);
      color:#fff;
      font-weight:500;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      box-shadow:inset 0 1px 2px rgba(255,255,255,0.4), 0 2px 4px rgba(0,0,0,0.2);
      transition:background 0.2s;
    }
    button:active { background:rgba(255,255,255,0.5); }
    input { display:none; }

    /* Loading overlay */
    #loading {
      position:fixed; inset:0;
      background:#111;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      color:#fff; font-size:18px;
      z-index:10;
    }
    #progressBar {
      width:60%; height:8px; margin-top:20px;
      background:#333; border-radius:4px; overflow:hidden;
    }
    #progressFill {
      width:0%; height:100%; background:#4af; transition:width 0.2s;
    }

    /* Debug overlay */
    #debug {
      position:fixed; bottom:100px; left:10px;
      width:90%; max-height:40vh;
      overflow:auto; font-size:12px;
      background:rgba(0,0,0,0.85); color:#0f0;
      padding:8px; border-radius:8px;
      font-family:monospace;
      white-space:pre-wrap;
      z-index:20;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div>Loading‚Ä¶ <span id="progressText">0%</span></div>
    <div id="progressBar"><div id="progressFill"></div></div>
  </div>

  <input type="file" id="modelInput" accept=".glb,.gltf">
  <input type="file" id="textureInput" accept="image/*">

  <div id="ui">
    <button onclick="modelInput.click()">üìÇ Model</button>
    <button onclick="textureInput.click()">üñºÔ∏è Texture</button>
    <button onclick="exportGLB()">‚¨áÔ∏è Export</button>
  </div>

  <div id="debug">[Debugger ready]</div>
  <canvas id="c"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/exporters/GLTFExporter.js"></script>

  <script>
    // --- Debug overlay ---
    const debugEl = document.getElementById("debug");
    function logDebug(msg){ 
      debugEl.textContent += "\\n" + msg;
      debugEl.scrollTop = debugEl.scrollHeight;
    }
    // Redirect console methods
    ["log","warn","error"].forEach(fn=>{
      const orig = console[fn];
      console[fn] = (...args)=>{
        orig.apply(console,args);
        logDebug(fn.toUpperCase()+": "+args.join(" "));
      }
    });
    window.onerror = (m,s,l,c,e)=>{ logDebug("ERROR: "+m+" @"+s+":"+l); };

    // Loading UI
    const loadingEl = document.getElementById("loading");
    const progressText = document.getElementById("progressText");
    const progressFill = document.getElementById("progressFill");
    function setProgress(ratio){
      progressText.textContent = Math.round(ratio*100)+"%";
      progressFill.style.width = (ratio*100)+"%";
    }
    function updateProgress(xhr){
      if (xhr && xhr.lengthComputable) {
        setProgress(xhr.loaded / xhr.total);
      } else {
        let w = parseInt(progressFill.style.width) || 0;
        w = (w + 10) % 100;
        progressFill.style.width = w + "%";
        progressText.textContent = "Loading‚Ä¶";
      }
    }

    // Three.js setup
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 1.5, 3);

    let renderer = new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setClearColor(0xffffff, 1);

    let controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0,1,0);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(3,5,2);
    scene.add(dirLight);

    const roomSize = 12;
    const roomGeo = new THREE.BoxGeometry(roomSize, roomSize, roomSize);
    const roomMat = new THREE.MeshStandardMaterial({ color:0xffffff, side:THREE.BackSide });
    scene.add(new THREE.Mesh(roomGeo, roomMat));

    let model = null;

    // Model loading
    modelInput.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      const loader = new THREE.GLTFLoader();

      setProgress(0);
      loadingEl.style.display = "flex";

      loader.load(url, gltf=>{
        if(model) scene.remove(model);
        model = gltf.scene;
        scene.add(model);
        console.log("Model loaded:", file.name);
        setProgress(1);
        setTimeout(()=>loadingEl.style.display="none",500);
      }, updateProgress, err=>{
        console.error("Model load failed:", err);
        loadingEl.style.display="none";
      });
    });

    // Texture loading
    textureInput.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file || !model) return;
      const url = URL.createObjectURL(file);
      setProgress(0);
      loadingEl.style.display="flex";

      new THREE.TextureLoader().load(url, tex=>{
        tex.flipY = false;
        model.traverse(o=>{
          if(o.isMesh){
            o.material.map = tex;
            o.material.needsUpdate = true;
          }
        });
        console.log("Texture applied:", file.name);
        setProgress(1);
        setTimeout(()=>loadingEl.style.display="none",500);
      }, updateProgress, err=>{
        console.error("Texture load failed:", err);
        loadingEl.style.display="none";
      });
    });

    function exportGLB(){
      if(!model) return alert("No model loaded!");
      const exporter = new THREE.GLTFExporter();
      exporter.parse(model, glb=>{
        const blob = new Blob([glb], {type:'model/gltf-binary'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'export.glb';
        a.click();
        console.log("Model exported as export.glb");
      }, {binary:true});
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    addEventListener('resize',()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
    });

    // Hide initial loader after boot
    setTimeout(()=>loadingEl.style.display="none",1000);
  </script>
</body>
</html>